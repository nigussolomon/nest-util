name: Publish Libs

on:
  push:
    branches: [publish]

permissions:
  contents: write

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  nest-audit:
    name: Build & Verify nest-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - run: pnpm install --frozen-lockfile

      - name: Test @nest-util/nest-audit
        run: pnpm nx test @nest-util/nest-audit

      - name: Build @nest-util/nest-audit
        run: pnpm nx build @nest-util/nest-audit

      - name: Create Tarball
        run: |
          cp libs/nest-audit/package.json libs/nest-audit/dist/package.json
          cd libs/nest-audit/dist
          # Fix paths in package.json to be relative to the current folder (dist)
          jq '(.main, .module, .types, .exports["."].types, .exports["."].import, .exports["."].default) |= sub("^\\./dist/"; "./") | del(.files) | del(.exports["."]["@nest-util/source"])' package.json > package.json.tmp && mv package.json.tmp package.json
          pnpm pack --pack-destination ../../../

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nest-audit-tgz
          path: nest-util-nest-audit-*.tgz
          retention-days: 7

  nest-crud:
    name: Build & Verify nest-crud
    needs: nest-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - run: pnpm install --frozen-lockfile

      - name: Test @nest-util/nest-crud
        run: pnpm nx test @nest-util/nest-crud

      - name: Build @nest-util/nest-crud
        run: pnpm nx build @nest-util/nest-crud

      - name: Download nest-audit package
        uses: actions/download-artifact@v4
        with:
          name: nest-audit-tgz
          path: ./artifacts

      - name: Validate nest-audit artifact exists
        run: ls -1 ./artifacts/nest-util-nest-audit-*.tgz

      - name: Create Tarball
        run: |
          cp libs/nest-crud/package.json libs/nest-crud/dist/package.json
          cd libs/nest-crud/dist
          # Fix paths in package.json to be relative to the current folder (dist)
          jq '(.main, .module, .types, .exports["."].types, .exports["."].import, .exports["."].default) |= sub("^\\./dist/"; "./") | .peerDependencies["@nest-util/nest-audit"] = "https://github.com/nigussolomon/nest-util/releases/download/latest/ncnu-0.0.1.tgz" | del(.files) | del(.exports["."]["@nest-util/source"])' package.json > package.json.tmp && mv package.json.tmp package.json
          pnpm pack --pack-destination ../../../

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nest-crud-tgz
          path: nest-util-nest-crud-*.tgz
          retention-days: 7

  ncnu:
    name: Build & Verify ncnu
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - run: pnpm install --frozen-lockfile

      - name: Build ncnu
        run: pnpm nx build ncnu

      - name: Create Tarball
        run: |
          mkdir -p dist/libs/ncnu/bin
          cp libs/ncnu/package.json dist/libs/ncnu/package.json
          cp libs/ncnu/bin/ncnu.js dist/libs/ncnu/bin/ncnu.js
          cd dist/libs/ncnu
          # Fix entry points and remove devDependencies
          jq '.main |= sub("\\.ts$"; ".js") | del(.devDependencies)' package.json > package.json.tmp && mv package.json.tmp package.json
          pnpm pack --pack-destination ../../../

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ncnu-tgz
          path: ncnu-*.tgz
          retention-days: 7

  nest-auth:
    name: Build & Verify nest-auth
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - run: pnpm install --frozen-lockfile

      - name: Test @nest-util/nest-auth
        run: pnpm nx test @nest-util/nest-auth

      - name: Build @nest-util/nest-auth
        run: pnpm nx build @nest-util/nest-auth

      - name: Create Tarball
        run: |
          cp libs/nest-auth/package.json libs/nest-auth/dist/package.json
          cd libs/nest-auth/dist
          # Fix paths in package.json to be relative to the current folder (dist)
          jq '(.main, .module, .types, .exports["."].types, .exports["."].import, .exports["."].default) |= sub("^\\./dist/"; "./") | del(.files) | del(.exports["."]["@nest-util/source"])' package.json > package.json.tmp && mv package.json.tmp package.json
          pnpm pack --pack-destination ../../../

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nest-auth-tgz
          path: nest-util-nest-auth-*.tgz
          retention-days: 7

  nest-file:
    name: Build & Verify nest-file
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - run: pnpm install --frozen-lockfile

      - name: Test @nest-util/nest-file
        run: pnpm nx test @nest-util/nest-file

      - name: Build @nest-util/nest-file
        run: pnpm nx build @nest-util/nest-file

      - name: Create Tarball
        run: |
          cp libs/nest-file/package.json libs/nest-file/dist/package.json
          cd libs/nest-file/dist
          # Fix paths in package.json to be relative to the current folder (dist)
          jq '(.main, .module, .types, .exports["."].types, .exports["."].import, .exports["."].default) |= sub("^\\./dist/"; "./") | del(.files) | del(.exports["."]["@nest-util/source"])' package.json > package.json.tmp && mv package.json.tmp package.json
          pnpm pack --pack-destination ../../../

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nest-file-tgz
          path: nest-util-nest-file-*.tgz
          retention-days: 7

  release:
    name: Publish release assets
    runs-on: ubuntu-latest
    needs:
      - nest-audit
      - nest-crud
      - ncnu
      - nest-auth
      - nest-file
    steps:
      - name: Download nest-audit artifact
        uses: actions/download-artifact@v4
        with:
          name: nest-audit-tgz
          path: ./release-artifacts

      - name: Download nest-crud artifact
        uses: actions/download-artifact@v4
        with:
          name: nest-crud-tgz
          path: ./release-artifacts

      - name: Download ncnu artifact
        uses: actions/download-artifact@v4
        with:
          name: ncnu-tgz
          path: ./release-artifacts

      - name: Download nest-auth artifact
        uses: actions/download-artifact@v4
        with:
          name: nest-auth-tgz
          path: ./release-artifacts

      - name: Download nest-file artifact
        uses: actions/download-artifact@v4
        with:
          name: nest-file-tgz
          path: ./release-artifacts

      - name: Publish combined release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          files: |
            release-artifacts/nest-util-nest-audit-*.tgz
            release-artifacts/nest-util-nest-crud-*.tgz
            release-artifacts/ncnu-*.tgz
            release-artifacts/nest-util-nest-auth-*.tgz
            release-artifacts/nest-util-nest-file-*.tgz
          prerelease: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
